<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base Q&A System - AI Education Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 优先加载修复脚本 -->
    <script src="js/force_fix.js"></script>
    <!-- 先加载config.js确保配置在使用前已定义 -->
    <script src="js/config.js"></script>
    <script src="js/url_override.js"></script>
    <!-- 加载RAG页面主要JS功能 -->
    <script src="js/rag.js"></script>
    <style>
        /* 全局变量 */
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #93c5fd;
            --secondary-color: #6c757d;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --light-color: #f8f9fa;
            --dark-color: #1f2937;
            --white-color: #ffffff;
            --gray-color: #6b7280;
            --gray-dark-color: #374151;
            --gray-light-color: #f3f4f6;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e7eb;
            --primary-hover: #2563eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --header-height: 64px;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            --border-radius: 0.375rem;
            --spacing: 1rem;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #111827;
                --bg-secondary: #1f2937;
                --text-primary: #f9fafb;
                --text-secondary: #e5e7eb;
                --border-color: #374151;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 增强移动端体验 */
        @media (max-width: 768px) {
            :root {
                --header-height: 56px;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .page-title h2 {
                font-size: 1.5rem;
            }
            
            .chat-messages {
                min-height: 300px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .nav-links {
                gap: 0.5rem;
            }
            
            .nav-link {
                padding: 0.4rem 0.6rem;
                font-size: 0.9rem;
            }
            
            .upload-section {
                grid-template-columns: 1fr;
            }
        }
        
        /* 增强平板体验 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .upload-section {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
            
            .main-container {
                padding: 1.5rem;
            }
        }
        
        /* 顶部导航 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            height: var(--header-height);
            background-color: var(--bg-primary);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-area img {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s ease;
        }
        
        .logo-area img:hover {
            transform: scale(1.05);
        }
        
        .logo-area h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .nav-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all var(--transition-fast);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .nav-link i {
            font-size: 1.1rem;
        }
        
        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background-color: rgba(79, 70, 229, 0.2);
            transform: translateY(-2px);
        }
        
        /* 主要内容区 */
        .main-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            animation: fadeIn 0.5s ease;
        }
        
        .page-title {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .page-title h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        
        .page-title i {
            font-size: 1.75rem;
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.1);
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }
        
        /* 内容标签页 */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .tab {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        
        .tab:hover {
            background-color: rgba(79, 70, 229, 0.05);
            color: var(--primary-color);
        }
        
        .tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .tab i {
            font-size: 1rem;
        }
        
        /* 标签内容 */
        .tab-content {
            display: none;
            width: 100%;
            padding: 1.5rem;
            background-color: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* 聊天容器样式 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 600px;
            position: relative;
        }
        
        /* 消息区域样式 */
        .chat-messages {
            flex: 1;
            background-color: var(--bg-primary);
            border-radius: 1rem;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            min-height: 450px;
            border: 1px solid var(--border-color);
            scroll-behavior: smooth;
            position: relative;
        }
        
        .message {
            position: relative;
            max-width: 75%;
            border-radius: 1.25rem;
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-sm);
            animation: fadeIn 0.3s ease forwards;
            transition: transform 0.2s ease;
        }
        
        .message:hover {
            transform: translateY(-2px);
        }
        
        .user-message {
            align-self: flex-end;
            background: var(--gradient-primary);
            color: white;
            border-radius: 1.25rem 1.25rem 0.25rem 1.25rem;
        }
        
        .assistant-message {
            align-self: flex-start;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 1.25rem 1.25rem 1.25rem 0.25rem;
        }
        
        .system-message {
            align-self: center;
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            font-style: italic;
            max-width: 90%;
            text-align: center;
            animation: pulse 2s infinite;
            border: 1px dashed rgba(79, 70, 229, 0.3);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(79, 70, 229, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
            }
        }
        
        .message p {
            margin: 0;
            line-height: 1.6;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.5rem;
            text-align: right;
        }
        
        .references-container {
            margin-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding-top: 0.75rem;
        }
        
        .reference-title {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .reference-item {
            background-color: rgba(79, 70, 229, 0.05);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            border: 1px solid rgba(79, 70, 229, 0.1);
            transition: all var(--transition-fast);
        }
        
        .reference-item:hover {
            background-color: rgba(79, 70, 229, 0.1);
            transform: translateY(-2px);
        }
        
        /* 输入区域样式 */
        .chat-input-container {
            background: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 1.25rem;
            transition: all var(--transition-normal);
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .chat-input-container:focus-within {
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(79, 70, 229, 0.1);
            transform: translateY(-4px);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .textarea-wrapper {
            position: relative;
            flex: 1;
        }
        
        #chat-input {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            transition: all var(--transition-fast);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        #chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background-color: var(--bg-primary);
        }
        
        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rag-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-light-color);
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .send-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(79, 70, 229, 0.3);
        }
        
        .send-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }
        
        /* 加载动画 */
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        
        .loading-dots {
            display: flex;
            align-items: center;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
            margin: 0 4px;
            animation: dot-flashing 1s infinite linear alternate;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .loading-dot:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes dot-flashing {
            0% {
                background-color: var(--primary-light);
                transform: scale(1);
            }
            100% {
                background-color: var(--primary-color);
                transform: scale(1.3);
            }
        }
        
        /* 进度条 */
        .progress-container {
            margin: 1rem 0;
            background-color: #efefef;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            line-height: 20px;
            font-size: 0.8rem;
            transition: width 0.3s ease;
        }
        
        /* 上传队列样式 */
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        
        .queue-item:hover {
            background-color: #e9ecef;
        }
        
        .queue-item-info {
            display: flex;
            align-items: center;
        }
        
        .file-icon {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .file-details {
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .file-size {
            font-size: 0.8rem;
            color: var(--gray-color);
        }
        
        .queue-item-actions {
            display: flex;
            align-items: center;
        }
        
        /* 消息样式 */
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            position: relative;
            max-width: 85%;
        }
        
        .user-message {
            background-color: #e3f2fd;
            color: #0d47a1;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        
        .assistant-message {
            background-color: #f5f5f5;
            color: #333;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--gray-color);
            text-align: right;
            margin-top: 0.25rem;
        }
        
        .references-container {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e0e0e0;
            font-size: 0.8rem;
        }
        
        .reference-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .reference-item {
            padding: 0.5rem;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            margin-bottom: 0.25rem;
        }
        
        /* 系统消息 */
        .system-message {
            background-color: #fff3cd;
            color: #856404;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            text-align: center;
            width: 100%;
        }
        
        /* 文档列表 */
        .document-name-cell {
            display: flex;
            align-items: center;
        }
        
        .document-name-cell i {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
        }
        
        /* 文档上传样式 */
        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .upload-card {
            background-color: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }
        
        .upload-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .upload-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .upload-card h3 i {
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.1);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            font-family: inherit;
            transition: all var(--transition-fast);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background-color: var(--bg-primary);
        }
        
        .form-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        
        .form-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* 文件拖放区域 */
        .file-drop-area {
            border: 2px dashed var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            transition: all var(--transition-fast);
            position: relative;
            margin-bottom: 1.5rem;
            background-color: var(--bg-secondary);
        }
        
        .file-drop-area.highlight {
            border-color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.05);
            transform: scale(1.01);
        }
        
        .file-drop-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            opacity: 0.6;
        }
        
        .drop-text {
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .select-files-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
            margin: 0 auto;
        }
        
        .select-files-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .file-input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 1;
        }
        
        /* 上传队列 */
        .upload-queue {
            background-color: var(--bg-primary);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-top: 2rem;
            box-shadow: var(--shadow-sm);
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .queue-header h4 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .queue-header h4 i {
            color: var(--primary-color);
        }
        
        .queue-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
        }
        
        .primary-action-btn {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .primary-action-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .primary-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .secondary-action-btn {
            background-color: rgba(100, 116, 139, 0.1);
            color: var(--text-secondary);
        }
        
        .secondary-action-btn:hover {
            background-color: rgba(100, 116, 139, 0.2);
        }
        
        .secondary-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .queue-body {
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .upload-queue-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background-color: var(--bg-secondary);
            margin-bottom: 0.75rem;
            border: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }
        
        .queue-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .queue-item-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .file-icon {
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.1);
            border-radius: 0.5rem;
        }
        
        .file-details {
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .file-size {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .queue-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .remove-btn {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .remove-btn:hover {
            background-color: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }
        
        .empty-queue-message {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
            font-style: italic;
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            border: 1px dashed var(--border-color);
            margin: 0.5rem 0;
        }
        
        /* 文档管理样式 */
        .manage-section {
            background-color: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .action-bar h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .action-bar h3 i {
            color: var(--primary-color);
            background-color: rgba(79, 70, 229, 0.1);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .refresh-btn {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            border: none;
            border-radius: 0.75rem;
            padding: 0.6rem 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
        }
        
        .refresh-btn:hover {
            background-color: rgba(79, 70, 229, 0.2);
            transform: translateY(-2px);
        }
        
        .document-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .document-table th,
        .document-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .document-table th {
            font-weight: 600;
            color: var(--text-primary);
            background-color: var(--bg-secondary);
        }
        
        .document-table tr:last-child td {
            border-bottom: none;
        }
        
        .document-table tbody tr {
            transition: all var(--transition-fast);
            background-color: var(--bg-primary);
        }
        
        .document-table tbody tr:hover {
            background-color: rgba(79, 70, 229, 0.05);
        }
        
        .document-name-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .document-name-cell i {
            color: var(--primary-color);
            font-size: 1.25rem;
            background-color: rgba(79, 70, 229, 0.1);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--text-secondary);
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            margin-top: 2rem;
            border: 1px dashed var(--border-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            color: var(--border-color);
            margin-bottom: 1rem;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
        
        .empty-state button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        
        .empty-state button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* 标签样式 */
        .tag-badge {
            display: inline-block;
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border-radius: 30px;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            margin-right: 0.35rem;
            margin-bottom: 0.35rem;
            white-space: nowrap;
            font-weight: 500;
        }
        
        /* 预览模态框样式 */
        .preview-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 1rem;
            line-height: 1.6;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        /* 渐变背景效果 */
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
        }
        
        /* 元数据展示样式 */
        .document-metadata {
            margin-bottom: 1.5rem;
            padding: 0.75rem 1rem;
            background-color: rgba(37, 99, 235, 0.05);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary-color);
        }
        
        .metadata-item {
            margin-bottom: 0.5rem;
        }
        
        .metadata-item:last-child {
            margin-bottom: 0;
        }
        
        /* 上传进度条美化 */
        .progress-container {
            margin: 1rem 0;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 12px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), #3b82f6);
            color: white;
            text-align: center;
            line-height: 12px;
            font-size: 0.7rem;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: progress-animation 1s linear infinite;
        }
        
        @keyframes progress-animation {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 20px 0;
            }
        }
        
        /* 全局加载指示器 */
        .global-loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            backdrop-filter: blur(3px);
        }
        
        .loading-spinner {
            margin-bottom: 1rem;
        }
        
        .spinner-circle {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-message {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            max-width: 80%;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
        }
        
        .modal-content {
            position: relative;
            background-color: var(--bg-primary);
            margin: 10% auto;
            padding: 0;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 500px;
            transform: translateY(-30px);
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gradient-primary);
            color: white;
        }
        
        .modal-header h3 {
            margin: 0;
            font-weight: 600;
            font-size: 1.2rem;
            letter-spacing: -0.01em;
        }
        
        .close-btn {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: white;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 1.5rem;
            color: var(--text-primary);
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        .modal-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .primary-btn {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .primary-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .secondary-btn {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .secondary-btn:hover {
            background-color: var(--light-color);
            transform: translateY(-2px);
        }
        
        /* 预览模态框样式 */
        .preview-modal-content {
            max-width: 800px;
            width: 90%;
        }
        
        .preview-modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .preview-content {
            font-family: inherit;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        /* 全局加载指示器 */
        .global-loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .global-loading-indicator.show {
            opacity: 1;
        }
        
        .loading-spinner {
            margin-bottom: 1.5rem;
        }
        
        .spinner-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        .loading-message {
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            max-width: 80%;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .pulse {
            animation: pulse 2s ease infinite;
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <div class="header">
        <div class="logo-area">
            <img src="img/BJTU.jpeg" alt="Logo">
            <h1>AI Education Assistant</h1>
        </div>
        
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="react_agent.html" class="nav-link">
                <i class="fas fa-robot"></i> Agent System
            </a>
            <a href="rag.html" class="nav-link active">
                <i class="fas fa-search"></i> Knowledge Base Q&A
            </a>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- 主要内容区 -->
    <div class="main-container">
        <div class="page-title">
            <i class="fas fa-search"></i>
            <h2>Knowledge Base Q&A System</h2>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="chat">
                <i class="fas fa-comment-dots"></i> Q&A Chat
            </button>
            <button class="tab" data-tab="upload">
                <i class="fas fa-upload"></i> Document Upload
            </button>
            <button class="tab" data-tab="manage">
                <i class="fas fa-folder"></i> Document Management
            </button>
        </div>
        
        <!-- 以下内容将在后续修改中完成 -->
        
        <!-- 问答对话界面 -->
        <div class="tab-content active" id="chat-content">
            <div class="chat-container">
                <!-- 添加知识库介绍区域 -->
                <div class="system-description" style="margin-bottom: 2rem; background: rgba(255, 255, 255, 0.7); border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                    <h3 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-info-circle"></i> About Knowledge Base Q&A System
                    </h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); line-height: 1.6;">
                        The Knowledge Base Q&A System is based on Retrieval Augmented Generation (RAG) technology, which can retrieve relevant information from the documents you upload, provide accurate and evidence-based answers, and display information sources.
                    </p>
                    <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem;">
                        <div style="flex: 1; min-width: 200px;">
                            <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-brain" style="color: var(--primary-color);"></i> Features
                            </h4>
                            <ul style="list-style: none; padding-left: 1.5rem; color: var(--text-secondary);">
                                <li style="margin-bottom: 0.5rem; position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Precise retrieval of document knowledge, reducing hallucination
                                </li>
                                <li style="margin-bottom: 0.5rem; position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Provide reference sources, enhancing the credibility of answers
                                </li>
                                <li style="position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Support multiple document formats, making it easy to build a knowledge base
                                </li>
                            </ul>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-lightbulb" style="color: var(--primary-color);"></i> Usage Tips
                            </h4>
                            <ul style="list-style: none; padding-left: 1.5rem; color: var(--text-secondary);">
                                <li style="margin-bottom: 0.5rem; position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Upload relevant documents to the knowledge base first
                                </li>
                                <li style="margin-bottom: 0.5rem; position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Ask clear and specific questions to get the best answers
                                </li>
                                <li style="position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Switch between using/not using the knowledge base enhancement
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                        <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-tools" style="color: var(--primary-color);"></i> System Functions
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem;">
                            <div style="background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-comment-dots" style="color: var(--primary-color); font-size: 1.1rem;"></i>
                                    <h5 style="font-size: 0.95rem; color: var(--text-primary); margin: 0;">Smart Question Answering</h5>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                    Automatically retrieve relevant information from the knowledge base and generate accurate and evidence-based answers based on your questions.
                                </p>
                            </div>
                            
                            <div style="background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-upload" style="color: var(--primary-color); font-size: 1.1rem;"></i>
                                    <h5 style="font-size: 0.95rem; color: var(--text-primary); margin: 0;">Document Upload</h5>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                    Support uploading PDF, Word, TXT, etc. documents, automatically extracting and indexing content.
                                </p>
                            </div>
                            
                            <div style="background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-folder" style="color: var(--primary-color); font-size: 1.1rem;"></i>
                                    <h5 style="font-size: 0.95rem; color: var(--text-primary); margin: 0;">Document Management</h5>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                    View, preview, and delete uploaded documents, manage your knowledge base content.
                                </p>
                            </div>
                            
                            <div style="background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-quote-right" style="color: var(--primary-color); font-size: 1.1rem;"></i>
                                    <h5 style="font-size: 0.95rem; color: var(--text-primary); margin: 0;">Reference Sources</h5>
                                </div>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0;">
                                    Automatically reference information sources in answers, improving transparency and credibility, making it easy to verify.
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding: 1rem; background-color: rgba(79, 70, 229, 0.05); border-radius: 0.75rem; border: 1px dashed rgba(79, 70, 229, 0.3);">
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                                Before using, please visit the "Document Upload" tab page to upload your documents. After uploading, the system will automatically process and index the content, and then you can ask questions on this page.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="system-message">
                        <p>Hello, I'm an AI assistant based on the knowledge base. Please enter your question, and I'll provide you with accurate answers based on the relevant knowledge.</p>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="input-group">
                        <div class="textarea-wrapper">
                            <textarea id="chat-input" placeholder="Please enter your question..." rows="3"></textarea>
                        </div>
                        <div class="input-actions">
                            <div class="rag-toggle">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="use-rag-check" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span>Use knowledge base enhanced answers</span>
                            </div>
                            <button class="send-btn" id="send-btn">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                                        
        <!-- 文档上传内容 -->
        <div class="tab-content" id="upload-content">
            <div class="upload-container">
                <!-- 添加上传指南 -->
                <div class="upload-guide" style="margin-bottom: 2rem; background: rgba(255, 255, 255, 0.7); border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                    <h3 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-upload"></i> Document Upload Guide
                    </h3>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary); line-height: 1.6;">
                        By uploading relevant documents, you can build your own knowledge base. The system will automatically analyze the document content and establish an index, allowing AI to retrieve information to answer questions.
                    </p>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 2rem; margin-top: 1rem;">
                        <div style="flex: 1; min-width: 300px;">
                            <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-alt" style="color: var(--primary-color);"></i> Supported File Formats
                            </h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="display: inline-block; padding: 0.35rem 0.75rem; background: rgba(79, 70, 229, 0.1); border-radius: 1rem; font-size: 0.85rem; color: var(--primary-color);">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </span>
                                <span style="display: inline-block; padding: 0.35rem 0.75rem; background: rgba(79, 70, 229, 0.1); border-radius: 1rem; font-size: 0.85rem; color: var(--primary-color);">
                                    <i class="fas fa-file-word"></i> DOCX
                                </span>
                                <span style="display: inline-block; padding: 0.35rem 0.75rem; background: rgba(79, 70, 229, 0.1); border-radius: 1rem; font-size: 0.85rem; color: var(--primary-color);">
                                    <i class="fas fa-file-alt"></i> TXT
                                </span>
                                <span style="display: inline-block; padding: 0.35rem 0.75rem; background: rgba(79, 70, 229, 0.1); border-radius: 1rem; font-size: 0.85rem; color: var(--primary-color);">
                                    <i class="fab fa-markdown"></i> MD
                                </span>
                            </div>
                        </div>
                        
                        <div style="flex: 1; min-width: 300px;">
                            <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-info-circle" style="color: var(--primary-color);"></i> Upload Instructions
                            </h4>
                            <ul style="list-style: none; padding-left: 1.5rem; color: var(--text-secondary);">
                                <li style="margin-bottom: 0.5rem; position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Single file support up to 50MB
                                </li>
                                <li style="margin-bottom: 0.5rem; position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Optional title, author, and tags for management
                                </li>
                                <li style="position: relative;">
                                    <i class="fas fa-check" style="color: var(--primary-color); position: absolute; left: -1.5rem; top: 0.3rem;"></i>
                                    Support batch upload and drag-and-drop operations
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background-color: rgba(79, 70, 229, 0.05); border-radius: 0.75rem; border: 1px dashed rgba(79, 70, 229, 0.3);">
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-lightbulb" style="color: var(--primary-color);"></i>
                            <span>Tip: Uploading documents related to your question topic can get you a more accurate answer. After the document is successfully uploaded, you can view and manage it in the "Document Management" tab page.</span>
                        </p>
                    </div>
                </div>
                
                <div class="upload-section">
                    <h3><i class="fas fa-file-upload"></i> Upload Documents</h3>
                    <p class="section-desc"></p>
                    
                    <div class="upload-area">
                        <div class="file-drop-area" id="drop-area">
                            <input type="file" id="file-input" multiple class="file-input" accept=".pdf,.docx,.doc,.txt,.md">
                            <div class="file-drop-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <p class="drop-text">Drag and drop files here or</p>
                            <button id="select-files-btn" class="select-files-btn">Select Files</button>
                        </div>
                        
                        <!-- 添加文档元数据字段 -->
                        <div class="document-metadata">
                            <div class="form-group">
                                <label for="file-title">Document Title (Optional)</label>
                                <input type="text" id="file-title" class="form-input" placeholder="Enter document title">
                            </div>
                            <div class="form-group">
                                <label for="file-author">Author (Optional)</label>
                                <input type="text" id="file-author" class="form-input" placeholder="Enter author name">
                            </div>
                            <div class="form-group">
                                <label for="file-tags">Tags (Optional, separated by commas)</label>
                                <input type="text" id="file-tags" class="form-input" placeholder="e.g., education, AI, research">
                            </div>
                        </div>
                        
                        <div class="upload-queue">
                            <div class="queue-header">
                                <h4>Upload Queue</h4>
                                <div class="queue-actions">
                                    <button id="upload-all-btn" class="action-btn primary-action-btn" disabled>
                                        <i class="fas fa-upload"></i> Upload All
                                    </button>
                                    <button id="clear-queue-btn" class="action-btn secondary-action-btn" disabled>
                                        <i class="fas fa-times"></i> Clear Queue
                                    </button>
                                </div>
                            </div>
                            <div class="queue-body">
                                <div id="empty-queue-message" class="empty-queue-message">No files to upload</div>
                                <ul id="upload-queue-list" class="upload-queue-list"></ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 添加调试信息区域 -->
                <div class="debug-container" style="margin-top: 2rem;">
                    <div class="debug-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h4 style="margin: 0; font-size: 1rem; color: var(--text-secondary);">
                            <i class="fas fa-bug" style="margin-right: 0.5rem;"></i> Debug Information
                        </h4>
                        <button id="toggle-debug-btn" class="action-btn secondary-action-btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                            Show Logs
                        </button>
                    </div>
                    <div id="debug-info" class="debug-info" style="display: none;"></div>
                    
                    <!-- API测试工具 -->
                    <div class="debug-header" style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0 0.5rem 0;">
                        <h4 style="margin: 0; font-size: 1rem; color: var(--text-secondary);">
                            <i class="fas fa-tools" style="margin-right: 0.5rem;"></i> API Test Tool
                        </h4>
                    </div>
                    <div class="api-test-container" style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; border: 1px solid #dee2e6;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <select id="api-test-method" style="padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color);">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                            <input type="text" id="api-test-url" placeholder="Enter API URL" style="flex: 1; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color);" value="">
                            <button id="api-test-btn" class="action-btn primary-action-btn" style="padding: 0.5rem 1rem;">Test</button>
                        </div>
                        <div>
                            <textarea id="api-test-body" placeholder="Request body (JSON format, only POST)" style="width: 100%; height: 100px; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color); margin-bottom: 1rem;"></textarea>
                        </div>
                        <div id="api-test-result" style="background-color: #ffffff; padding: 1rem; border-radius: 0.375rem; border: 1px solid var(--border-color); white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <script>
                        // 重新定义控制台日志以捕获到调试面板
                        (function() {
                            const oldLog = console.log;
                            const oldError = console.error;
                            const oldWarn = console.warn;
                            const debugInfo = document.getElementById('debug-info');
                            
                            if (debugInfo) {
                                console.log = function() {
                                    oldLog.apply(console, arguments);
                                    const msg = Array.from(arguments).map(arg => 
                                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
                                    ).join(' ');
                                    appendToDebug('[LOG] ' + msg);
                                };
                                
                                console.error = function() {
                                    oldError.apply(console, arguments);
                                    const msg = Array.from(arguments).map(arg => 
                                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
                                    ).join(' ');
                                    appendToDebug('[ERROR] ' + msg);
                                };
                                
                                console.warn = function() {
                                    oldWarn.apply(console, arguments);
                                    const msg = Array.from(arguments).map(arg => 
                                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
                                    ).join(' ');
                                    appendToDebug('[WARN] ' + msg);
                                };
                                
                                function appendToDebug(message) {
                                    const time = new Date().toLocaleTimeString();
                                    debugInfo.innerHTML += `[${time}] ${message}\n`;
                                    debugInfo.scrollTop = debugInfo.scrollHeight;
                                }
                                
                                document.getElementById('toggle-debug-btn').addEventListener('click', function() {
                                    if (debugInfo.style.display === 'none') {
                                        debugInfo.style.display = 'block';
                                        this.textContent = 'Hide Logs';
                                    } else {
                                        debugInfo.style.display = 'none';
                                        this.textContent = 'Show Logs';
                                    }
                                });
                            }
                            
                            // API测试工具功能
                            const apiTestBtn = document.getElementById('api-test-btn');
                            const apiTestUrl = document.getElementById('api-test-url');
                            const apiTestMethod = document.getElementById('api-test-method');
                            const apiTestBody = document.getElementById('api-test-body');
                            const apiTestResult = document.getElementById('api-test-result');
                            
                            if (apiTestBtn && apiTestUrl && apiTestResult) {
                                // 预设URL
                                apiTestUrl.addEventListener('focus', function() {
                                    if (!this.value) {
                                        this.value = RAG_BASE_URL + '/rag/documents';
                                    }
                                });
                                
                                // 执行测试
                                apiTestBtn.addEventListener('click', function() {
                                    const method = apiTestMethod.value;
                                    const url = apiTestUrl.value;
                                    
                                    if (!url) {
                                        apiTestResult.textContent = 'Please enter API URL';
                                        return;
                                    }
                                    
                                    apiTestResult.textContent = 'Sending request...';
                                    
                                    const options = {
                                        method: method,
                                        headers: {}
                                    };
                                    
                                    if (method === 'POST' && apiTestBody.value) {
                                        try {
                                            const bodyData = JSON.parse(apiTestBody.value);
                                            options.body = JSON.stringify(bodyData);
                                            options.headers['Content-Type'] = 'application/json';
                                        } catch (e) {
                                            apiTestResult.textContent = 'Request body must be a valid JSON format';
                                            return;
                                        }
                                    }
                                    
                                    fetch(url, options)
                                        .then(response => {
                                            const result = {
                                                status: response.status,
                                                statusText: response.statusText,
                                                headers: {}
                                            };
                                            
                                            // 获取响应头
                                            response.headers.forEach((value, key) => {
                                                result.headers[key] = value;
                                            });
                                            
                                            return response.text().then(text => {
                                                try {
                                                    result.data = JSON.parse(text);
                                                } catch (e) {
                                                    result.data = text;
                                                }
                                                return result;
                                            });
                                        })
                                        .then(result => {
                                            apiTestResult.textContent = JSON.stringify(result, null, 2);
                                        })
                                        .catch(error => {
                                            apiTestResult.textContent = `Request failed: ${error.message}`;
                                        });
                                });
                            }
                        })();

                        // 添加网络错误检测
                        window.addEventListener('error', function(e) {
                            if (e.target.tagName === 'IMG' || e.target.tagName === 'SCRIPT') {
                                console.error(`Resource loading failed: ${e.target.src || e.target.href}`);
                            }
                        }, true);
                    </script>
                </div>
            </div>
        </div>
                                        
        <!-- 文档管理界面 -->
        <div class="tab-content" id="manage-content">
            <!-- 添加管理指南 -->
            <div class="manage-guide" style="margin-bottom: 2rem; background: rgba(255, 255, 255, 0.7); border-radius: 1rem; padding: 1.5rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                <h3 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-folder"></i> Document Management Guide
                </h3>
                <p style="margin-bottom: 1rem; color: var(--text-secondary); line-height: 1.6;">
                    On this page, you can view, preview, and manage all documents uploaded to the knowledge base. Good knowledge base management can help improve the quality of answers.
                </p>
                
                <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-top: 1rem;">
                    <div style="flex: 1; min-width: 250px; background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                        <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-search" style="color: var(--primary-color);"></i> View Document
                        </h4>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0;">
                            Click the "View" button in the document row to preview the document content and understand the information in the knowledge base.
                        </p>
                    </div>
                    
                    <div style="flex: 1; min-width: 250px; background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                        <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trash-alt" style="color: var(--primary-color);"></i> Delete Document
                        </h4>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0;">
                            Unwanted documents can be deleted. The system will automatically update the knowledge base index. Deletion is irreversible, please proceed with caution.
                        </p>
                    </div>
                    
                    <div style="flex: 1; min-width: 250px; background: rgba(248, 249, 250, 0.8); border-radius: 0.75rem; padding: 1rem; border: 1px solid var(--border-color);">
                        <h4 style="font-size: 1rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-sync-alt" style="color: var(--primary-color);"></i> Refresh List
                        </h4>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0;">
                            Click the "Refresh List" button to get the latest status of documents, ensuring that the most recently uploaded or processed documents are displayed.
                        </p>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background-color: rgba(79, 70, 229, 0.05); border-radius: 0.75rem; border: 1px dashed rgba(79, 70, 229, 0.3);">
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-lightbulb" style="color: var(--primary-color);"></i>
                        <span>Tip: Regularly manage your knowledge base by deleting outdated or irrelevant documents and uploading the latest materials to ensure that AI answers are based on the most accurate and up-to-date information.</span>
                    </p>
                </div>
            </div>
            
            <div class="manage-section">
                <div class="action-bar">
                    <h3>Document List</h3>
                    <button class="refresh-btn" id="refresh-docs-btn">
                        <i class="fas fa-sync-alt"></i> Refresh List
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="document-table">
                        <thead>
                            <tr>
                                <th>Document ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Tags</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documents-table">
                            <!-- 文档列表将在JavaScript中动态生成 -->
                        </tbody>
                    </table>
                </div>
                
                <div class="empty-state" id="empty-state" style="display:none;">
                    <i class="fas fa-folder-open"></i>
                    <p>No documents</p>
                    <button class="tab" data-tab="upload">
                        <i class="fas fa-upload"></i> Upload Documents
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 预览对话框 -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="preview-title">Document Preview</h3>
                <button id="preview-close-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="preview-content" class="preview-content"></div>
            </div>
            <div class="modal-footer">
                <button id="preview-footer-close-btn" class="btn-secondary close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- 成功对话框 -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Operation Successful</h3>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p id="success-message"></p>
            </div>
            <div class="modal-footer">
                <button id="success-ok-btn" class="modal-btn primary-btn">OK</button>
            </div>
        </div>
    </div>
    
    <!-- 错误对话框 -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Error Occurred</h3>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <p id="error-message"></p>
            </div>
            <div class="modal-footer">
                <button id="error-ok-btn" class="modal-btn primary-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script>
        // API基础URL
        window.RAG_BASE_URL = 'http://localhost:8000';
        
        // 改进函数：显示模态框
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.style.display = 'block';
            // 使用setTimeout允许CSS过渡效果生效
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        // 改进函数：隐藏模态框
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.remove('show');
            // 等待过渡完成后隐藏
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // 改进函数：显示错误消息
        function showError(message) {
            const errorModal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            
            if (errorModal && errorMessage) {
                errorMessage.textContent = message;
                showModal('error-modal');
                console.error(message);
            } else {
                console.error('错误:', message);
                alert(message);
            }
        }
        
        // 改进函数：显示成功消息
        function showSuccess(message) {
            const successModal = document.getElementById('success-modal');
            const successMessage = document.getElementById('success-message');
            
            if (successModal && successMessage) {
                successMessage.textContent = message;
                showModal('success-modal');
                console.log(message);
            } else {
                console.log('成功:', message);
                alert(message);
            }
        }
        
        // 改进函数：显示加载状态
        function showLoading(message) {
            // 创建或获取加载指示器
            let loadingIndicator = document.getElementById('global-loading');
            
            if (!loadingIndicator) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'global-loading';
                loadingIndicator.className = 'global-loading-indicator';
                
                loadingIndicator.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-circle"></div>
                    </div>
                    <div class="loading-message"></div>
                `;
                
                document.body.appendChild(loadingIndicator);
            }
            
            // 设置加载消息
            const msgElement = loadingIndicator.querySelector('.loading-message');
            if (msgElement) {
                msgElement.textContent = message || '加载中...';
            }
            
            // 显示加载指示器
            loadingIndicator.style.display = 'flex';
            setTimeout(() => {
                loadingIndicator.classList.add('show');
            }, 10);
        }
        
        // 改进函数：隐藏加载状态
        function hideLoading() {
            // 获取加载指示器
            const loadingIndicator = document.getElementById('global-loading');
            if (loadingIndicator) {
                loadingIndicator.classList.remove('show');
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 300);
            }
        }

        // 确保RAG_API全局变量存在
        if (typeof RAG_API === 'undefined') {
            console.warn('RAG_API未在全局定义，创建默认配置');
            window.RAG_API = {
                upload: 'http://localhost:8000/rag/document/upload/file',
                documents: 'http://localhost:8000/rag/documents',
                document: function(id) { return `http://localhost:8000/rag/document/${id}`; },
                query: 'http://localhost:8000/rag/query',
                documentContent: 'http://localhost:8000/rag/document/content',
                deleteDocument: 'http://localhost:8000/rag/document/delete'
            };
        }
        
        // 确保RAG_BASE_URL全局变量存在
        if (typeof RAG_BASE_URL === 'undefined') {
            console.warn('RAG_BASE_URL未在全局定义，使用默认值');
            window.RAG_BASE_URL = 'http://localhost:8000';
        }
        
        // 确保RAG_BASE_URL全局变量存在
        if (typeof RAG_BASE_URL === 'undefined') {
            console.warn('RAG_BASE_URL未在全局定义，使用默认值');
            window.RAG_BASE_URL = 'http://localhost:8000';
        }
        
        // 检查API配置是否已正确加载
        document.addEventListener('DOMContentLoaded', function() {
            console.log('%c===== API 配置信息 =====', 'background: #4b0082; color: white; padding: 4px;');
            console.log('RAG_BASE_URL:', RAG_BASE_URL);
            console.log('RAG_BASE_URL:', RAG_BASE_URL);
            console.log('RAG_API:', RAG_API);
            console.log('%c=======================', 'background: #4b0082; color: white; padding: 4px;');
            
            // 检查API连接
            if (typeof checkApiConnection === 'function') {
                console.log('使用config.js中定义的checkApiConnection函数');
                checkApiConnection();
            } else {
                console.warn('checkApiConnection未定义，使用内部函数检查API连接');
                // 内部API连接检查
                const healthCheckUrl = `${RAG_BASE_URL}/health`;
                console.log('发送健康检查请求到:', healthCheckUrl);
                
                fetch(healthCheckUrl, { method: 'GET' })
                    .then(response => {
                        console.log('健康检查响应状态:', response.status);
                        if (response.ok) {
                            console.log('✅ API服务正常');
                            return response.json();
                        }
                        throw new Error('API连接失败');
                    })
                    .then(data => {
                        console.log('API状态信息:', data);
                    })
                    .catch(error => {
                        console.error('❌ API连接检查失败:', error);
                        console.warn('请确保后端服务已启动并运行在正确的端口上');
                        showError('API连接失败，请确保后端服务已启动');
                    });
            }
            
            // 初始化界面
            initializeRAGInterface();
        });
        
        // 当前页码
        let currentPage = 1;
        // 搜索查询
        let searchQuery = '';
        // 文件队列
        let fileQueue = [];
        
        // 初始化RAG界面
        function initializeRAGInterface() {
            // 防止重复初始化的标志
            if (window.isRAGInterfaceInitialized) {
                console.log('RAG界面已初始化，跳过重复初始化');
                return;
            }
            
            // 获取DOM元素
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const refreshDocsBtn = document.getElementById('refresh-docs-btn');
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const selectFilesBtn = document.getElementById('select-files-btn');
            const uploadAllBtn = document.getElementById('upload-all-btn');
            const clearQueueBtn = document.getElementById('clear-queue-btn');
            
            // 添加事件监听器
            if (sendBtn && chatInput) {
                sendBtn.addEventListener('click', function() {
                    sendMessage();
                });
                
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                    
                    // 如果切换到管理标签页，刷新文档列表
                    if (tabId === 'manage') {
                        loadDocuments();
                    }
                });
            });
            
            // 选择文件按钮点击事件
            if (selectFilesBtn && fileInput) {
                selectFilesBtn.addEventListener('click', function() {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', function() {
                    handleFileSelection(this.files);
                });
            }
            
            // 初始化拖放区域
            if (dropArea) {
                initializeDropArea();
            }
            
            // 上传和清空按钮事件
            if (uploadAllBtn && clearQueueBtn) {
                uploadAllBtn.addEventListener('click', function() {
                    uploadFiles();
                });
                
                clearQueueBtn.addEventListener('click', function() {
                    fileQueue = [];
                    updateUploadQueue();
                    uploadAllBtn.disabled = true;
                    clearQueueBtn.disabled = true;
                });
            }
            
            // 刷新文档列表
            if (refreshDocsBtn) {
                refreshDocsBtn.addEventListener('click', function() {
                    loadDocuments();
                });
            }
            
            // 退出登录按钮点击事件
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('username');
                    window.location.href = 'login.html';
                });
            }
            
            // 初始化模态框
            initializeModals();
            
            // 默认加载聊天标签页
            switchTab('chat');
            
            // 加载文档列表（确保管理页面也有数据）
            loadDocuments();
            
            // 设置已初始化标志
            window.isRAGInterfaceInitialized = true;
            console.log('RAG界面初始化完成');
        }
        
        // 标签页切换
        function switchTab(tabId) {
            // 移除所有标签页的active类
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 隐藏所有内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // 添加选中标签页的active类
            const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // 显示选中的内容
            const selectedContent = document.getElementById(`${tabId}-content`);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
        }
        
        // 初始化模态框
        function initializeModals() {
            // 获取模态框元素
            const previewModal = document.getElementById('preview-modal');
            const successModal = document.getElementById('success-modal');
            const errorModal = document.getElementById('error-modal');
            
            // 关闭按钮事件
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        hideModal(modal.id);
                    }
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    hideModal(event.target.id);
                }
            });
            
            // 确认按钮事件
            document.getElementById('success-ok-btn').addEventListener('click', function() {
                hideModal('success-modal');
            });
            
            document.getElementById('error-ok-btn').addEventListener('click', function() {
                hideModal('error-modal');
            });
            
            document.getElementById('preview-footer-close-btn').addEventListener('click', function() {
                hideModal('preview-modal');
            });
        }
        
        // 初始化拖放区域
        function initializeDropArea() {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            
            // 阻止默认行为，避免浏览器直接打开文件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            // 添加高亮效果
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, function() {
                    dropArea.classList.add('highlight');
                }, false);
            });
            
            // 移除高亮效果
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, function() {
                    dropArea.classList.remove('highlight');
                }, false);
            });
            
            // 处理文件拖放
            dropArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelection(files);
            }, false);
        }
        
        // 处理文件选择
        function handleFileSelection(files) {
            if (files.length === 0) return;
            
            // 将FileList转换为数组
            const filesArray = Array.from(files);
            
            // 过滤合法文件
            filesArray.forEach(file => {
                // 检查文件类型
                const fileExt = file.name.split('.').pop().toLowerCase();
                const allowedTypes = ['pdf', 'docx', 'doc', 'txt', 'md'];
                if (!allowedTypes.includes(fileExt)) {
                    showError(`文件类型 .${fileExt} 不支持，请选择PDF、DOCX、DOC、TXT或MD文件`);
                    return;
                }
                
                // 检查文件大小（限制为50MB）
                if (file.size > 50 * 1024 * 1024) {
                    showError(`文件 ${file.name} 超过50MB限制，无法上传`);
                    return;
                }
                
                // 检查是否已存在重复文件
                if (fileQueue.some(queuedFile => queuedFile.name === file.name)) {
                    console.log(`文件 ${file.name} 已在队列中`);
                    return;
                }
                
                // 添加到队列
                fileQueue.push(file);
            });
            
            // 更新UI
            updateUploadQueue();
            
            // 更新按钮状态
            const uploadAllBtn = document.getElementById('upload-all-btn');
            const clearQueueBtn = document.getElementById('clear-queue-btn');
            
            if (uploadAllBtn && clearQueueBtn) {
                uploadAllBtn.disabled = fileQueue.length === 0;
                clearQueueBtn.disabled = fileQueue.length === 0;
            }
        }
        
        // 更新上传队列UI
        function updateUploadQueue() {
            const queueList = document.getElementById('upload-queue-list');
            const emptyMessage = document.getElementById('empty-queue-message');
            
            if (!queueList || !emptyMessage) return;
            
            if (fileQueue.length === 0) {
                queueList.innerHTML = '';
                emptyMessage.style.display = 'block';
                return;
            }
            
            emptyMessage.style.display = 'none';
            queueList.innerHTML = '';
            
            fileQueue.forEach((file, index) => {
                const fileExt = file.name.split('.').pop().toLowerCase();
                const fileIcon = getFileIcon(fileExt);
                const fileSize = formatFileSize(file.size);
                
                const listItem = document.createElement('li');
                listItem.className = 'queue-item';
                listItem.innerHTML = `
                    <div class="queue-item-info">
                        <div class="file-icon">
                            <i class="${fileIcon}"></i>
                        </div>
                        <div class="file-details">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                    </div>
                    <div class="queue-item-actions">
                        <button class="action-btn remove-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                queueList.appendChild(listItem);
            });
            
            // 添加移除按钮事件
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'), 10);
                    if (!isNaN(index) && index >= 0 && index < fileQueue.length) {
                        fileQueue.splice(index, 1);
                        updateUploadQueue();
                        
                        // 更新按钮状态
                        const uploadAllBtn = document.getElementById('upload-all-btn');
                        const clearQueueBtn = document.getElementById('clear-queue-btn');
                        
                        if (uploadAllBtn && clearQueueBtn) {
                            uploadAllBtn.disabled = fileQueue.length === 0;
                            clearQueueBtn.disabled = fileQueue.length === 0;
                        }
                    }
                });
            });
        }
        
        // 获取文件图标
        function getFileIcon(fileExt) {
            switch (fileExt) {
                case 'pdf': return 'fas fa-file-pdf';
                case 'doc':
                case 'docx': return 'fas fa-file-word';
                case 'txt': return 'fas fa-file-alt';
                case 'md': return 'fab fa-markdown';
                default: return 'fas fa-file';
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 消息发送功能
        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');
            const useRagCheck = document.getElementById('use-rag-check');
            
            if (!chatInput || !chatMessages) return;
            
            const message = chatInput.value.trim();
            if (message === '') return;
            
            // 清空输入框
            chatInput.value = '';
            
            // 添加用户消息到聊天区域
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'message user-message';
            userMessageElement.innerHTML = `
                <p>${message}</p>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(userMessageElement);
            
            // 滚动到底部
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // 显示加载状态
            const loadingElement = document.createElement('div');
            loadingElement.className = 'loading-indicator';
            loadingElement.innerHTML = `
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            chatMessages.appendChild(loadingElement);
            
            // 发送API请求
            fetch(RAG_API.query, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: message,
                    use_rag: useRagCheck ? useRagCheck.checked : true
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 移除加载状态
                chatMessages.removeChild(loadingElement);
                
                // 添加AI回复
                const assistantMessageElement = document.createElement('div');
                assistantMessageElement.className = 'message assistant-message';
                
                let content = `<p>${DOMPurify.sanitize(marked.parse(data.answer))}</p>`;
                
                // 添加引用来源
                if (data.contexts && data.contexts.length > 0) {
                    content += `
                        <div class="references-container">
                            <div class="reference-title">Reference Sources:</div>
                    `;
                    
                    data.contexts.forEach(ref => {
                        content += `<div class="reference-item">${ref.text.substring(0, 150)}...</div>`;
                    });
                    
                    content += `</div>`;
                }
                
                content += `<div class="message-time">${new Date().toLocaleTimeString()}</div>`;
                
                assistantMessageElement.innerHTML = content;
                chatMessages.appendChild(assistantMessageElement);
                
                // 滚动到底部
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => {
                console.error('查询失败:', error);
                
                // 移除加载状态
                chatMessages.removeChild(loadingElement);
                
                // 添加错误消息
                const errorElement = document.createElement('div');
                errorElement.className = 'system-message';
                errorElement.innerHTML = `<p>查询失败: ${error.message}</p>`;
                chatMessages.appendChild(errorElement);
            });
        }
        
        // 加载文档列表
        function loadDocuments() {
            console.log('%c===== 加载文档列表 =====', 'background: #008080; color: white; padding: 4px;');
            console.log('当前RAG_BASE_URL:', RAG_BASE_URL);
            console.log('当前RAG_BASE_URL:', RAG_BASE_URL);
            console.log('当前RAG_API.documents:', RAG_API.documents);
            
            // 显示加载状态
            const documentsTable = document.getElementById('documents-table');
            const emptyState = document.getElementById('empty-state');
            
            if (!documentsTable || !emptyState) return;
            
            documentsTable.innerHTML = '<tr><td colspan="5" class="text-center">加载中...</td></tr>';
            emptyState.style.display = 'none';
            
            // 构建API请求URL
            const url = `${RAG_API.documents}?page=${currentPage}&search=${encodeURIComponent(searchQuery || '')}`;
            console.log('请求文档列表URL:', url);
            
            // 发送API请求
            console.log('开始发送fetch请求到:', url);
            fetch(url, { 
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            })
                .then(response => {
                    console.log('文档列表响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('获取到文档数据:', data);
                    
                    // 处理不同格式的API响应
                    const formattedData = {
                        documents: [],
                        total_pages: 1,
                        current_page: 1,
                        total_documents: 0
                    };
                    
                    // 如果返回doc_ids数组，将其转换为文档对象数组
                    if (data.doc_ids && Array.isArray(data.doc_ids)) {
                        formattedData.documents = data.doc_ids.map(id => {
                            return {
                                id: id,
                                title: id,
                                author: '-',
                                tags: '-',
                                size: '-',
                                date: '-'
                            };
                        });
                        formattedData.total_documents = data.doc_ids.length;
                    } 
                    // 如果有标准documents数组
                    else if (data.documents && Array.isArray(data.documents)) {
                        formattedData.documents = data.documents;
                        formattedData.total_documents = data.documents.length;
                        if (data.total_pages) formattedData.total_pages = data.total_pages;
                        if (data.current_page) formattedData.current_page = data.current_page;
                        if (data.total_documents) formattedData.total_documents = data.total_documents;
                    }
                    
                    updateDocumentsList(formattedData);
                })
                .catch(error => {
                    console.error('获取文档列表失败:', error);
                    showError('无法加载文档列表: ' + error.message);
                    
                    // 显示空状态
                    documentsTable.innerHTML = '';
                    emptyState.style.display = 'flex';
                });
        }
        
        // 更新文档列表
        function updateDocumentsList(data) {
            const documentsTable = document.getElementById('documents-table');
            const emptyState = document.getElementById('empty-state');
            
            if (!documentsTable || !emptyState) return;
            
            if (!data.documents || data.documents.length === 0) {
                // 没有文档，显示空状态
                documentsTable.innerHTML = '';
                emptyState.style.display = 'flex';
                return;
            }
            
            // 有文档，隐藏空状态
            emptyState.style.display = 'none';
            documentsTable.innerHTML = '';
            
            // 添加文档行
            data.documents.forEach(doc => {
                const row = document.createElement('tr');
                
                // 获取文件图标
                const fileExt = doc.title ? doc.title.split('.').pop().toLowerCase() : '';
                const fileIcon = getFileIcon(fileExt);
                
                // 格式化标签显示
                let tagsDisplay = doc.tags || '-';
                if (tagsDisplay !== '-' && tagsDisplay.indexOf(',') > -1) {
                    // 如果有多个标签，以标签的形式显示
                    const tagArray = tagsDisplay.split(',').map(tag => tag.trim());
                    tagsDisplay = tagArray.map(tag => 
                        `<span class="tag-badge">${tag}</span>`
                    ).join(' ');
                }
                
                row.innerHTML = `
                    <td>${doc.id}</td>
                    <td>
                        <div class="document-name-cell">
                            <i class="${fileIcon}"></i>
                            <span>${doc.title || doc.id}</span>
                        </div>
                    </td>
                    <td>${doc.author || '-'}</td>
                    <td>${tagsDisplay}</td>
                    <td>
                        <button class="action-btn view-btn" data-id="${doc.id}">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="action-btn delete-btn" data-id="${doc.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                
                documentsTable.appendChild(row);
            });
            
            // 添加按钮事件
            documentsTable.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const docId = this.getAttribute('data-id');
                    viewDocument(docId);
                });
            });
            
            documentsTable.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const docId = this.getAttribute('data-id');
                    deleteDocument(docId);
                });
            });
        }
        
        // 其他功能代码会根据需要继续添加...
        
        // 上传文件功能
        function uploadFiles() {
            if (fileQueue.length === 0) {
                showError('没有文件可上传');
                return;
            }
            
            showLoading('正在上传文件...');
            
            // 创建进度显示
            const uploadProgress = document.getElementById('upload-progress');
            if (uploadProgress) {
                uploadProgress.style.display = 'block';
                uploadProgress.innerHTML = `<div class="progress-bar" style="width: 0%;">0%</div>`;
            }
            
            // 保存上传状态
            let totalFiles = fileQueue.length;
            let successCount = 0;
            let failCount = 0;
            
            // 逐个上传文件
            const uploadPromises = fileQueue.map((file, index) => {
                return new Promise((resolve, reject) => {
                    // 创建FormData
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    // 添加元数据
                    const metaData = {
                        filename: file.name,
                        content_type: file.type
                    };
                    formData.append('meta', JSON.stringify(metaData));
                    
                    // 发送API请求
                    fetch(RAG_API.upload, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => {
                        console.log(`文件 ${file.name} 上传响应状态:`, response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP错误! 状态: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`文件 ${file.name} 上传成功:`, data);
                        successCount++;
                        
                        // 更新进度条
                        updateProgress(index + 1, totalFiles);
                        
                        resolve(data);
                    })
                    .catch(error => {
                        console.error(`文件 ${file.name} 上传失败:`, error);
                        failCount++;
                        
                        // 更新进度条
                        updateProgress(index + 1, totalFiles);
                        
                        reject(error);
                    });
                });
            });
            
            // 处理所有上传完成后的操作
            Promise.allSettled(uploadPromises)
                .then(results => {
                    hideLoading();
                    
                    // 隐藏进度条
                    if (uploadProgress) {
                        uploadProgress.style.display = 'none';
                    }
                    
                    // 显示上传结果
                    if (failCount === 0) {
                        showSuccess(`所有 ${successCount} 个文件上传成功!`);
                    } else {
                        showError(`上传完成，${successCount} 个成功，${failCount} 个失败`);
                    }
                    
                    // 清空队列
                    fileQueue = [];
                    updateUploadQueue();
                    
                    // 禁用按钮
                    const uploadAllBtn = document.getElementById('upload-all-btn');
                    const clearQueueBtn = document.getElementById('clear-queue-btn');
                    if (uploadAllBtn && clearQueueBtn) {
                        uploadAllBtn.disabled = true;
                        clearQueueBtn.disabled = true;
                    }
                    
                    // 刷新文档列表
                    loadDocuments();
                });
        }
        
        // 更新进度条
        function updateProgress(current, total) {
            const uploadProgress = document.getElementById('upload-progress');
            if (!uploadProgress) return;
            
            const percentage = Math.round((current / total) * 100);
            uploadProgress.innerHTML = `<div class="progress-bar" style="width: ${percentage}%;">${percentage}%</div>`;
        }
        
        // 查看文档
        function viewDocument(docId) {
            if (!docId) return;
            
            console.log('查看文档:', docId);
            showLoading('正在加载文档...');
            
            // 构建API请求URL
            const url = `${RAG_API.documentContent}?doc_id=${encodeURIComponent(docId)}`;
            
            // 发送API请求
            fetch(url)
                .then(response => {
                    console.log('文档内容响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('获取到文档内容:', data);
                    hideLoading();
                    
                    // 提取文档内容
                    let content = '';
                    let title = docId;
                    let author = '-';
                    let tags = '-';

                    if (data.content) {
                        content = data.content;
                    } else if (data.document && data.document.content) {
                        content = data.document.content;
                        title = data.document.title || docId;
                        author = data.document.author || '-';
                        tags = data.document.tags || '-';
                    } else if (data.text) {
                        content = data.text;
                    } else {
                        throw new Error('无法获取文档内容');
                    }
                    
                    // 创建预览模态框
                    const previewModal = document.getElementById('preview-modal');
                    const previewTitle = document.getElementById('preview-title');
                    const previewContent = document.getElementById('preview-content');
                    
                    if (!previewModal || !previewTitle || !previewContent) {
                        throw new Error('预览模态框元素不存在');
                    }
                    
                    // 设置预览标题和内容
                    previewTitle.textContent = title;

                    // 添加文档元数据展示
                    let metadataHTML = '';
                    if (author !== '-' || tags !== '-') {
                        metadataHTML = `<div class="document-metadata">`;
                        if (author !== '-') {
                            metadataHTML += `<div class="metadata-item"><strong>作者:</strong> ${author}</div>`;
                        }
                        if (tags !== '-') {
                            // 处理标签显示
                            let tagsDisplay = tags;
                            if (tagsDisplay.indexOf(',') > -1) {
                                const tagArray = tagsDisplay.split(',').map(tag => tag.trim());
                                tagsDisplay = tagArray.map(tag => 
                                    `<span class="tag-badge">${tag}</span>`
                                ).join(' ');
                            }
                            metadataHTML += `<div class="metadata-item"><strong>标签:</strong> ${tagsDisplay}</div>`;
                        }
                        metadataHTML += `</div>`;
                    }
                    
                    // 格式化并清理内容
                    previewContent.innerHTML = `
                        ${metadataHTML}
                        <div class="document-content">
                            ${DOMPurify.sanitize(marked.parse(content))}
                        </div>
                    `;
                    
                    // 显示预览模态框
                    showModal('preview-modal');
                })
                .catch(error => {
                    console.error('获取文档内容失败:', error);
                    hideLoading();
                    showError('无法查看文档: ' + error.message);
                });
        }
        
        // 删除文档
        function deleteDocument(docId) {
            if (!docId) return;
            
            // 确认删除
            if (!confirm(`确定要删除文档 ${docId} 吗？此操作不可撤销。`)) {
                return;
            }
            
            console.log('删除文档:', docId);
            showLoading('正在删除文档...');
            
            // 构建API请求URL
            const url = RAG_API.deleteDocument;
            
            // 发送API请求
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ doc_id: docId })
            })
                .then(response => {
                    console.log('删除文档响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('删除文档响应:', data);
                    hideLoading();
                    
                    showSuccess(`文档 ${docId} 已成功删除!`);
                    
                    // 刷新文档列表
                    loadDocuments();
                })
                .catch(error => {
                    console.error('删除文档失败:', error);
                    hideLoading();
                    showError('无法删除文档: ' + error.message);
                });
        }
        
        // 搜索文档
        function searchDocuments(query) {
            searchQuery = query || '';
            currentPage = 1;
            loadDocuments();
        }
        
        // DOM加载完成后初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM已加载，正在检查API状态...');
            
            // 确保RAG_API已定义（仅输出日志，不重新定义）
            if (typeof RAG_API === 'undefined') {
                console.warn('RAG_API未定义！这不应该发生，请检查config.js是否正确加载');
            } else {
                console.log('使用已经定义的RAG_API配置');
            }
            
            console.log('API基础URL:', RAG_BASE_URL);
            console.log('RAG_BASE_URL:', RAG_BASE_URL);
            console.log('RAG API配置:', RAG_API);
            
            try {
                // 检查API连接
                const healthUrl = `${RAG_BASE_URL}/health`;
                console.log('检查RAG服务健康状态:', healthUrl);
                
                fetch(healthUrl)
                    .then(response => {
                        console.log('健康检查响应状态:', response.status);
                        if (response.ok) {
                            console.log('RAG服务健康检查通过');
                            // 现在检查文档API
                            console.log('检查文档API:', RAG_API.documents);
                            return fetch(RAG_API.documents);
                        } else {
                            throw new Error(`健康检查失败! 状态: ${response.status}`);
                        }
                    })
                    .then(response => {
                        console.log('文档API响应状态:', response.status);
                        console.log('API连接成功');
                        // 初始化RAG界面
                        initializeRAGInterface();
                    })
                    .catch(error => {
                        console.error('API连接检查失败:', error);
                        showError('无法连接到API服务: ' + error.message);
                    });
            } catch (error) {
                console.error('初始化错误:', error);
                showError('初始化失败: ' + error.message);
            }
            
            // 初始化搜索框
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            
            if (searchInput && searchBtn) {
                searchBtn.addEventListener('click', function() {
                    const query = searchInput.value.trim();
                    searchDocuments(query);
                });
                
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = searchInput.value.trim();
                        searchDocuments(query);
                    }
                });
            }
            
            // 初始化API测试工具
            initializeApiTester();
        });
        
        // 初始化API测试工具
        function initializeApiTester() {
            const apiUrlInput = document.getElementById('api-url');
            const apiMethodSelect = document.getElementById('api-method');
            const apiBodyInput = document.getElementById('api-body');
            const apiSendBtn = document.getElementById('api-send-btn');
            const apiResult = document.getElementById('api-result');
            const clearLogsBtn = document.getElementById('clear-logs-btn');
            
            if (!apiUrlInput || !apiMethodSelect || !apiBodyInput || !apiSendBtn || !apiResult) {
                console.warn('API测试工具元素不存在');
                return;
            }
            
            // 发送API请求
            apiSendBtn.addEventListener('click', function() {
                const url = apiUrlInput.value.trim();
                if (!url) {
                    apiResult.textContent = '请输入API端点';
                    apiResult.classList.add('error');
                    return;
                }
                
                // 构建完整URL
                let fullUrl = url;
                if (!url.startsWith('http') && !url.startsWith('/')) {
                    fullUrl = '/' + url;
                }
                if (!url.startsWith('http')) {
                    fullUrl = RAG_BASE_URL + fullUrl;
                }
                
                // 获取请求方法
                const method = apiMethodSelect.value;
                
                // 准备请求选项
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // 如果有请求体
                if (method !== 'GET' && apiBodyInput.value.trim()) {
                    try {
                        const bodyObj = JSON.parse(apiBodyInput.value.trim());
                        options.body = JSON.stringify(bodyObj);
                    } catch (e) {
                        apiResult.textContent = '请求体JSON格式错误: ' + e.message;
                        apiResult.classList.add('error');
                        return;
                    }
                }
                
                // 设置结果
                apiResult.textContent = '发送请求中...';
                apiResult.classList.remove('error');
                
                // 发送请求
                fetch(fullUrl, options)
                    .then(response => {
                        const statusText = `${response.status} ${response.statusText}`;
                        return response.text().then(text => {
                            try {
                                // 尝试解析为JSON
                                const json = JSON.parse(text);
                                return {
                                    status: statusText,
                                    isJson: true,
                                    data: json
                                };
                            } catch (e) {
                                // 不是JSON，返回原始文本
                                return {
                                    status: statusText,
                                    isJson: false,
                                    data: text
                                };
                            }
                        });
                    })
                    .then(result => {
                        const resultText = `状态: ${result.status}\n\n${
                            result.isJson ? JSON.stringify(result.data, null, 2) : result.data
                        }`;
                        apiResult.textContent = resultText;
                        
                        if (result.status.startsWith('4') || result.status.startsWith('5')) {
                            apiResult.classList.add('error');
                        } else {
                            apiResult.classList.remove('error');
                        }
                    })
                    .catch(error => {
                        apiResult.textContent = '请求失败: ' + error.message;
                        apiResult.classList.add('error');
                    });
            });
            
            // 清除日志
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', function() {
                    const debugInfo = document.getElementById('debug-info');
                    if (debugInfo) {
                        debugInfo.textContent = '日志已清除';
                    }
                });
            }
        }
    </script>
    <script src="js/fix_api_calls.js"></script>
</body>
</html> 